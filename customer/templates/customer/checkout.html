{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}
<h1>주문서</h1>
<a href="{% url 'customer:s_logout' %}">로그아웃</a>
<h2>배송 정보</h2>
<div class="shipping-info">
    <div class="row mb-3">
        <div class="col-sm-6">
            {배송지 : 유저 기본 주소}
            <br>{{ user }}로 로그인 된 상태
            <p>{{user.email}}</p>
        </div>
        <div class="col">
            <button type="button" class="btn btn-secondary float-end">배송지 목록</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-6">
            <label for="postal_code">우편번호</label>
            <input type="text" disabled id="postal_code" name="postal_code" class="form-control" required>
        </div>
        <div class="col-sm-6">
            <div class="col">
                <input type="button" onclick="execDaumPostcode()" value="우편번호 찾기" class="btn btn-primary">
            </div>
        </div>
    </div>
    <div>
    <div class="row mb-3">
        <label for="shipping_address">주소</label>
        <input type="text" disabled id="shipping_address" name="shipping_address" class="form-control" required>
    </div>
    <div class="row mb-3">
        <label for="shipping_address_detail">상세 주소</label>
        <input type="text" id="shipping_address_detail" name="shipping_address_detail" class="form-control" required>
    </div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-6">
            <label for="recipient">수령인</label>
            <input type="text" id="recipient" name="recipient" class="form-control" required>
        </div>
        <div class="col-sm-6">
            <label for="recipient_phone_number">수령인 연락처</label>
            <input type="text" id="recipient_phone_number" name="recipient_phone_number" class="form-control" required>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h2 class="card-title">주문 상품</h2>
        <div class="order-items">
            <div class="row mb-3">
                <div class="col-md-2">
                    <img src="{% static 'example/소고기스테이크.png' %}" style="width: 100px;" alt="{{ product.product_name }}" class="img-fluid">
                </div>
                <div class="col-md-6 align-self-center">
                    <h4><a href="{% url 'customer:product_detail' product_id=product.product_id %}">{{ product.product_name }}</a></h4>
                    <p>{{ quantity }} 개</p>
                </div>
            </div>
            <div class="row mb-3">
                <p><a href="#">상품 판매자: {{ product.seller }}</a></p>
                <p>총 가격: {{ final_price|floatformat:"0" }}원 <span class="text-decoration-line-through text-secondary">{{ product.price|mul:quantity }}원</span></p>
            </div>
        </div>
    </div>
</div>

<h2>총 주문 가격</h2>
<div class="total-price">
    <p>{{ product.price|calc_discount:product.discount_rate|floatformat:"0" }}원</p>
</div>

<h2>결제 수단</h2>
<div class="payment-method">
    <select id="payment_method" name="payment_method" class="form-select" required>
        <option value="credit_card">신용카드</option>
        <option value="bank_transfer">계좌이체</option>
        <option value="cash">현금결제</option>
    </select>
</div>

<button type="submit" onclick="requestPay()" class="btn btn-primary mt-3">결제하기</button>
</form>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('postal_code').value = data.zonecode; // Set the postal code input value
                document.getElementById('shipping_address').value = data.address; // Set the address input value
            }
        }).open();
    }
</script>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>

var IMP = window.IMP;
    var code = "imp26236276";  // FIXME: 가맹점 식별코드
    IMP.init(code);

function requestPay() {
    // 결제요청
    IMP.request_pay({
        // name과 amount만 있어도 결제 진행가능
        pg : 'html5_inicis', // 이니시스 결제창 일반/정기결제
        pay_method : 'card', // 신용카드 
        merchant_uid : 'merchant_' + new Date().getTime(),
        name : '주문명:결제테스트',
        amount : {{ final_price|floatformat:"0" }},
        buyer_email : 'iamport@siot.do',
        buyer_name : '구매자이름',
        buyer_tel : '010-1234-5678',
        buyer_addr : '서울특별시 강남구 삼성동',
        buyer_postcode : '123-456',
        m_redirect_url : '{% url "customer:quick_checkout" %}'
    }, function(rsp) {
        if ( rsp.success ) {
            var msg = '결제가 완료되었습니다.';
            msg += '고유ID : ' + rsp.imp_uid;
            msg += '상점 거래ID : ' + rsp.merchant_uid;
            msg += '결제 금액 : ' + rsp.paid_amount;
            msg += '카드 승인번호 : ' + rsp.apply_num;
        }
        else {
            var msg = '결제에 실패하였습니다. 에러내용 : ' + rsp.error_msg
        }
        alert(msg);
    });
}
</script>
{% endblock %}